<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Bus GPS Sender</title>
</head>
<body>
<h2>Bus GPS Sender</h2>
<p id="status">Waiting for location...</p>
<p id="coords"></p>
<button id="toggle">Stop Sharing</button>

<script src="/socket.io/socket.io.js"></script>
<script>
const DEVICE_ID = "bus-001";
let sending = true;
const statusEl = document.getElementById("status");
const coordsEl = document.getElementById("coords");
const toggleBtn = document.getElementById("toggle");

// toggle sending
toggleBtn.onclick = () => {
  sending = !sending;
  toggleBtn.textContent = sending ? "Stop Sharing" : "Start Sharing";
  statusEl.textContent = sending ? "Sharing location..." : "Sharing paused";
};

// function to send to server
function sendLocation(lat, lon) {
  fetch("/update", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({id: DEVICE_ID, lat, lon, ts: Date.now()})
  }).catch(err => console.error(err));
}

// watch location
if ("geolocation" in navigator) {
  navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    coordsEl.textContent = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
    statusEl.textContent = sending ? "Sharing location..." : "Sharing paused";
    if(sending) sendLocation(lat, lon);
  }, err => {
    console.error(err);
    statusEl.textContent = "Error getting location: " + err.message;
  }, {enableHighAccuracy:true, maximumAge:2000, timeout:10000});
} else {
  alert("Geolocation not supported");
}
</script>
</body>
</html>
