<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bus Tracker Viewer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { margin: 0; }
    #map { height: 100vh; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <select id="routeSelect">
      <option value="">-- Select Route --</option>
    </select>
    <button id="showRoute">Show Route</button>
  </div>
  <div id="map"></div>

  <script>
    const map = L.map("map").setView([6.9271, 79.8612], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);

    let markers = {};
    let currentRouteLine = null;

    // Load routes list
    fetch("routes.json")
      .then(res => res.json())
      .then(routes => {
        const select = document.getElementById("routeSelect");
        Object.keys(routes).forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });

        document.getElementById("showRoute").onclick = () => {
          const selected = select.value;
          if (!selected) return;
          const coords = routes[selected];
          if (currentRouteLine) map.removeLayer(currentRouteLine);
          currentRouteLine = L.polyline(coords, {
            color: "blue",
            weight: 4
          }).addTo(map);
          map.fitBounds(currentRouteLine.getBounds());
        };
      });

    // Handle live location updates
    const socket = io();
    socket.on("location", data => {
      const { id, name, number, lat, lon } = data;
      if (!markers[id]) {
        markers[id] = L.marker([lat, lon]).addTo(map)
          .bindPopup(`${name} (${number})`);
      } else {
        markers[id].setLatLng([lat, lon]);
      }
    });
  </script>
</body>
</html>
